using System;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace BarcodeReceiver
{
    public partial class Form1 : Form
    {
        private const int DISCOVERY_PORT = 5051;
        private const int BARCODE_PORT = 5050;

        private UdpClient udpListener;
        private TcpListener tcpListener;
        private CancellationTokenSource cancelTokenSource;

        public Form1()
        {
            InitializeComponent();
            cancelTokenSource = new CancellationTokenSource();

            // Start both listeners safely
            _ = StartUdpListenerAsync(cancelTokenSource.Token);
            _ = StartTcpListenerAsync(cancelTokenSource.Token);
        }

        // ====================== UDP DISCOVERY LISTENER ======================
        private async Task StartUdpListenerAsync(CancellationToken token)
        {
            try
            {
                udpListener = new UdpClient(DISCOVERY_PORT);
                AppendLog("ðŸ–¥ï¸ UDP Discovery Listener started...");

                while (!token.IsCancellationRequested)
                {
                    try
                    {
                        var result = await udpListener.ReceiveAsync();

                        string message = Encoding.UTF8.GetString(result.Buffer);
                        if (message == "DISCOVER")
                        {
                            string machineName = Environment.MachineName;
                            byte[] response = Encoding.UTF8.GetBytes(machineName);
                            await udpListener.SendAsync(response, response.Length, result.RemoteEndPoint);

                            AppendLog($"ðŸ“¶ Discovery request from {result.RemoteEndPoint.Address} - replied with {machineName}");
                        }
                    }
                    catch (ObjectDisposedException)
                    {
                        break; // listener stopped
                    }
                    catch (Exception ex)
                    {
                        AppendLog($"âŒ UDP Error: {ex.Message}");
                    }
                }
            }
            catch (SocketException ex)
            {
                AppendLog($"âŒ Failed to start UDP listener: {ex.Message}");
            }
        }

        // ====================== TCP BARCODE LISTENER ======================
        private async Task StartTcpListenerAsync(CancellationToken token)
        {
            try
            {
                tcpListener = new TcpListener(IPAddress.Any, BARCODE_PORT);
                tcpListener.Start();
                AppendLog("ðŸ–¥ï¸ TCP Barcode Listener started...");

                while (!token.IsCancellationRequested)
                {
                    try
                    {
                        var client = await tcpListener.AcceptTcpClientAsync();
                        _ = HandleClientAsync(client, token);
                    }
                    catch (ObjectDisposedException)
                    {
                        break; // listener stopped
                    }
                    catch (Exception ex)
                    {
                        AppendLog($"âŒ TCP Error: {ex.Message}");
                    }
                }
            }
            catch (SocketException ex)
            {
                AppendLog($"âŒ Failed to start TCP listener: {ex.Message}");
            }
        }

        private async Task HandleClientAsync(TcpClient client, CancellationToken token)
        {
            try
            {
                using (client)
                using (var stream = client.GetStream())
                {
                    byte[] buffer = new byte[1024];
                    int bytesRead = await stream.ReadAsync(buffer, 0, buffer.Length, token);
                    string barcode = Encoding.UTF8.GetString(buffer, 0, bytesRead).Trim();

                    if (!string.IsNullOrEmpty(barcode))
                    {
                        AppendLog($"ðŸ“¦ Barcode received: {barcode}");
                        txtLog.Text = barcode;
                    }
                }
            }
            catch (Exception ex)
            {
                AppendLog($"âŒ Client handling error: {ex.Message}");
            }
        }

        // ====================== UI LOGGING HELPER ======================
        private void AppendLog(string message)
        {
            if (txtLog.InvokeRequired)
            {
                txtLog.Invoke(new Action(() =>
                    txtLog.AppendText($"{DateTime.Now:HH:mm:ss} - {message}{Environment.NewLine}")));
            }
            else
            {
                txtLog.AppendText($"{DateTime.Now:HH:mm:ss} - {message}{Environment.NewLine}");
            }
        }

        // ====================== FORM CLOSE CLEANUP ======================
        private void Form1_FormClosing(object sender, FormClosingEventArgs e)
        {
            try
            {
                cancelTokenSource?.Cancel();

                udpListener?.Close();
                tcpListener?.Stop();

                AppendLog("ðŸ›‘ Listeners stopped.");
            }
            catch { /* ignore cleanup exceptions */ }
        }
    }
}
